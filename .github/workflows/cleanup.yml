name: ğŸ§¹ Cleanup & Maintenance

on:
  schedule:
    # æ¯å‘¨æ—¥ UTC 3:00 è¿è¡Œæ¸…ç†ä»»åŠ¡
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'Type of cleanup to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - dev_deployments
          - old_releases
          - cache_purge

env:
  NODE_VERSION: '18'

jobs:
  # æ¸…ç†å¼€å‘ç¯å¢ƒéƒ¨ç½²
  cleanup-dev-deployments:
    name: ğŸ—‘ï¸ Cleanup Dev Deployments
    runs-on: ubuntu-latest
    if: github.event.inputs.cleanup_type == 'dev_deployments' || github.event.inputs.cleanup_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—‘ï¸ List and cleanup old dev workers
        run: |
          echo "Listing all workers..."
          npx wrangler list
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘
          # ä¾‹å¦‚åˆ é™¤è¶…è¿‡7å¤©çš„å¼€å‘ç¯å¢ƒéƒ¨ç½²
          echo "Cleanup logic would go here"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # æ¸…ç†æ—§ç‰ˆæœ¬
  cleanup-old-releases:
    name: ğŸ·ï¸ Cleanup Old Releases
    runs-on: ubuntu-latest
    if: github.event.inputs.cleanup_type == 'old_releases' || github.event.inputs.cleanup_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—‘ï¸ Delete old releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // ä¿ç•™æœ€æ–°çš„10ä¸ª releaseï¼Œåˆ é™¤å…¶ä½™çš„
            const releasesToDelete = releases.slice(10);
            
            for (const release of releasesToDelete) {
              if (!release.prerelease) {
                console.log(`Deleting release: ${release.tag_name}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                
                // åŒæ—¶åˆ é™¤å¯¹åº”çš„ tag
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `tags/${release.tag_name}`
                  });
                } catch (error) {
                  console.log(`Tag ${release.tag_name} may not exist or already deleted`);
                }
              }
            }

  # æ¸…ç†ç¼“å­˜
  purge-cache:
    name: ğŸ§¹ Purge Cache
    runs-on: ubuntu-latest
    if: github.event.inputs.cleanup_type == 'cache_purge' || github.event.inputs.cleanup_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Purge Cloudflare cache
        run: |
          # æ¸…ç† KV å­˜å‚¨ä¸­çš„è¿‡æœŸæ•°æ®
          if [ -n "${{ secrets.KV_NAMESPACE_ID }}" ]; then
            echo "Purging KV cache..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ  KV æ¸…ç†é€»è¾‘
            npx wrangler kv:key list --namespace-id="${{ secrets.KV_NAMESPACE_ID }}" || echo "No KV data to clean"
          fi
          
          # æ¸…ç† Cloudflare è¾¹ç¼˜ç¼“å­˜
          echo "Purging edge cache..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' || echo "Zone purge not configured"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # å¥åº·æ£€æŸ¥å’Œç›‘æ§
  health-monitoring:
    name: ğŸ¥ Health Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ¥ Check production health
        run: |
          HEALTH_URL="${{ vars.CUSTOM_DOMAIN || format('https://tgstate-prod.{0}.workers.dev', secrets.CLOUDFLARE_ACCOUNT_ID) }}/health"
          
          echo "Checking health at: $HEALTH_URL"
          
          RESPONSE=$(curl -s -w "%{http_code}" "$HEALTH_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed"
            echo "Response: $BODY"
          else
            echo "âŒ Health check failed with HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: ğŸ“Š Performance check
        run: |
          MAIN_URL="${{ vars.CUSTOM_DOMAIN || format('https://tgstate-prod.{0}.workers.dev', secrets.CLOUDFLARE_ACCOUNT_ID) }}"
          
          echo "Performance testing: $MAIN_URL"
          
          # æµ‹è¯•å“åº”æ—¶é—´
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$MAIN_URL")
          echo "Response time: ${RESPONSE_TIME}s"
          
          # å¦‚æœå“åº”æ—¶é—´è¶…è¿‡3ç§’ï¼Œå‘å‡ºè­¦å‘Š
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸ Warning: Response time is slow (${RESPONSE_TIME}s)"
          fi

  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-updates:
    name: ğŸ“¦ Check Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Check for outdated packages
        run: |
          echo "Checking for outdated packages..."
          npm outdated || true
          
          echo "Checking for security vulnerabilities..."
          npm audit --audit-level=moderate || true

      - name: ğŸ”„ Create dependency update issue
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            
            try {
              const outdated = execSync('npm outdated --json', { encoding: 'utf8' });
              const packages = JSON.parse(outdated);
              
              if (Object.keys(packages).length > 0) {
                const packageList = Object.entries(packages)
                  .map(([name, info]) => `- \`${name}\`: ${info.current} â†’ ${info.latest}`)
                  .join('\n');
                
                const issueBody = `## ğŸ“¦ Dependency Updates Available
                
                The following packages have updates available:
                
                ${packageList}
                
                ## ğŸ”§ Action Required
                
                Please review and update these dependencies:
                
                \`\`\`bash
                npm update
                npm audit fix
                \`\`\`
                
                ## ğŸ¤– Automated Check
                
                This issue was created automatically by the cleanup workflow.
                `;
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„ issue
                const { data: issues } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'dependencies'
                });
                
                const existingIssue = issues.find(issue => 
                  issue.title.includes('Dependency Updates Available')
                );
                
                if (!existingIssue) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: 'ğŸ“¦ Dependency Updates Available',
                    body: issueBody,
                    labels: ['dependencies', 'maintenance']
                  });
                }
              }
            } catch (error) {
              console.log('No outdated packages found or error occurred:', error.message);
            }

  # æŠ¥å‘Šæ¸…ç†ç»“æœ
  report-results:
    name: ğŸ“Š Report Results
    runs-on: ubuntu-latest
    needs: [cleanup-dev-deployments, cleanup-old-releases, purge-cache, health-monitoring, dependency-updates]
    if: always()
    steps:
      - name: ğŸ“Š Generate cleanup report
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'cleanup-dev-deployments': '${{ needs.cleanup-dev-deployments.result }}',
              'cleanup-old-releases': '${{ needs.cleanup-old-releases.result }}',
              'purge-cache': '${{ needs.purge-cache.result }}',
              'health-monitoring': '${{ needs.health-monitoring.result }}',
              'dependency-updates': '${{ needs.dependency-updates.result }}'
            };
            
            const report = Object.entries(results)
              .map(([job, result]) => {
                const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'â­ï¸';
                return `${emoji} ${job}: ${result}`;
              })
              .join('\n');
            
            console.log('Cleanup Report:');
            console.log(report);
            
            // å¦‚æœé…ç½®äº† Slackï¼Œå‘é€æŠ¥å‘Š
            if ('${{ secrets.SLACK_WEBHOOK_URL }}') {
              await fetch('${{ secrets.SLACK_WEBHOOK_URL }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: `ğŸ§¹ Weekly Cleanup Report`,
                  attachments: [{
                    color: 'good',
                    fields: [{
                      title: 'Cleanup Results',
                      value: report,
                      short: false
                    }]
                  }]
                })
              });
            }